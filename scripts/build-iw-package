#!/bin/bash


#----------------------------------------------------------------------------#
for FILE in /var/lib/iwlog/*.iwlog*;
do
    ### GET PACKAGE NAME AND VERSION ##
    echo Processing $FILE...

    ### CREATE DIFF FILE ###
    diff_file1=${FILE%.iwlog*}.difflog1
    diff_file2=${FILE%.iwlog*}.difflog2
    diff_file=${FILE%.iwlog*}.difflog

    diff $diff_file1 $diff_file2 > $diff_file

    ### FILTER DIFF FILE ###
    sed -i '/^>/!d' $diff_file
    sed -i 's/> //g' $diff_file
    sed -i '/iwlog/d' $diff_file

    ### CREATE PACKAGE FILE ###
    iwlog_file=${FILE%.raw}
    pkg_file=${iwlog_file%.iwlog}.pkg
    pkg_file_tmp=${iwlog_file%.iwlog}.pkg.tmp

    ### CREATE IWLOG FILE ###
    TAB=$'\t'
    omit="${TAB}rename\|${TAB}symlink\|${TAB}unlink\|${TAB}access\|${TAB}utimes"
    grep -v "$omit" $FILE | cut -f3 | grep "^/" | sed 's#^//#/#g' > $iwlog_file
    cat $FILE | cut -f4 | grep "^/" | sed 's#^//#/#g' >> $iwlog_file

    ### MERGE DIFF AND IWLOG FILES ###
    cat $diff_file $iwlog_file | sort -u > $pkg_file_tmp

    ### FILTER FILE ###
    sed -i '/^\/sources/d' $pkg_file_tmp
    sed -i '/^\/dev/d' $pkg_file_tmp
    sed -i '/^\/proc/d' $pkg_file_tmp
    sed -i '/^\/sys/d' $pkg_file_tmp
    sed -i '/^\/sources/d' $pkg_file_tmp
    sed -i '/^\/home/d' $pkg_file_tmp
    sed -i '/^\/etc\/passwd/d' $pkg_file_tmp
    sed -i '/^\/etc\/group/d' $pkg_file_tmp

    ### CHECK EXISTS ###
    if [[ -f $pkg_file ]]; then rm $pkg_file; fi
    while IFS= read -r line; do 
        if [[ -f $line ]] || [[ -d $line ]]; then
	    echo $line >> $pkg_file
	fi	    
    done < $pkg_file_tmp

    ### CREATE TAR ###
    tar_file="$pkg_file.tar"
    tar --no-recursion -cf $tar_file -T $pkg_file

    ### MAKE PACKAGE ###
    package=${FILE%.iwlog.raw}
    package="$package-x86_64-swl01.txz"
    mkdir extract
    cd extract

    # QT5 FIX
    if [[ $(grep '/opt/qt5' $pkg_file) ]]; then
        if [[ ! $(grep '/opt/qt-5.15.12' $pkg_file) ]]; then
            mkdir -pv ./opt/qt-5.15.12
        fi
    fi
    # KF5 FIX
    if [[ $(grep '/opt/kf5' $pkg_file) ]]; then
        if [[ ! $(grep '/opt/kf5-5.115.0' $pkg_file) ]]; then
            mkdir -pv ./opt/kf5-5.115.0
        fi
    fi

    tar -xf $tar_file
    makepkg -l y -c n $package
    mv -v $package /var/lib/packages/
    cd ../

    ### CLEANUP ###
    rm -rf extract
    rm $diff_file
    rm $iwlog_file
    rm $pkg_file_tmp
    rm $tar_file

done

exit
