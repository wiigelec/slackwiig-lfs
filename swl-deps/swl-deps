#!/bin/bash

#-----------------------------------------------------------------------------#
#
# swl-deps
# Dependency manager for slackwiig-lfs
#
#-----------------------------------------------------------------------------#

### CONFIGURATION ###
SCRIPT_DIR="$HOME/blfs_root/scripts"
INSTALL_DIR="/var/lib/pkgtools/packages"
PKG_DIR="/var/lib/swl/packages"
LIST_DIR="/var/lib/swl/lists"
MIRROR="http://localhost:8000/swl-packages.121/packages"

#-----------------------------------------------------------------------------#
function createList ( )
{
	if [[ -z "$location" ]]; then
		location=$SCRIPT_DIR
	fi

	for FILE in $location/*;
	do
		pkg=${FILE#*-z-}
		pkg=$(echo $pkg | tr '[:upper:]' '[:lower:]')
		found=$(grep ^$pkg $LIST_DIR/packages-121.list | head -n1)
		if [[ -z $found ]]; then
			found="NOT FOUND: $pkg"
		fi
		echo "$found-swl121.txz"
	done

}

#-----------------------------------------------------------------------------#
function testList ( )
{
	if [[ -z "$list" ]]; then 
		echo "No list specified" 
		exit
	fi

	cat $list \
		| sed 's/\(.*\)-x86_64.*/\1/g' \
		| sed 's/\(.*\)-\(.*\)/\1 \2/g' \
		| column -t
	
}

#-----------------------------------------------------------------------------#
function installStatus ( )
{
	if [[ -z "$list" ]]; then 
		echo "No list specified" 
		exit
	fi

	local tmp_outfile=$(mktemp /tmp/tmp_outfile.XXXXXXXXXX)

	# read file
    	while IFS= read -r line;
    	do
		local out_line=""
		# check installed
		out_line=$(check_installed $line)
		if [[ ! -z $out_line ]]; then
			echo "$line  INSTALLED" >> $tmp_outfile
			continue
		fi

		# check file
		out_line=$(check_file $line)
		if [[ ! -z $out_line ]]; then
			echo "$line  $out_line" >> $tmp_outfile
			continue
		fi

		# check mirror
		out_line=$(check_mirror $line)
		if [[ ! -z $out_line ]]; then
			echo "$line  $out_line" >> $tmp_outfile
			continue
		fi

		out_line="NOT FOUND"
		
		echo "$line  $out_line" >> $tmp_outfile

    	done < $list

	cat $tmp_outfile
	rm $tmp_outfile

}
#-----------------------------------------------------------------------------#
function downloadDeps ( )
{
	if [[ -z "$list" ]]; then 
		echo "No list specified" 
		exit
	fi
	
	# read list
    	while IFS= read -r line;
    	do
		# check mirror
		local url=$(check_mirror $line)
		if [[ -z $url ]]; then
			echo "SKIPPING $line: NOT FOUND ON MIRROR"
			continue
		fi

		# download
		wget -nv --show-progress -P $PKG_DIR $url -O $PKG_DIR/$line

    	done < $list
}

#-----------------------------------------------------------------------------#
function installDeps ( )
{
	if [[ -z "$list" ]]; then 
		echo "No list specified" 
		exit
	fi
	if [[ -z "$install_cmd" ]]; then 
		echo "No install command specified" 
		exit
	fi

	# read list
        while IFS= read -r line;
        do
		local pkg_file=$(check_installed $line)
		if [[ ! -z $pkg_file ]]; then
			echo "SKIPPING: $line INSTALLED"
			continue
		fi

		pkg_file=$(check_file $line)
		if [[ -z $pkg_file ]]; then
			echo "ERROR: $line NOT FOUND"
			break
		fi

		# install pkg
		$install_cmd $pkg_file
		
        done < $list

}

#-----------------------------------------------------------------------------#
function check_installed ( )
{
	pkg=$1
	pkg=${pkg%.txz}
	local output=""
	if [[ $(find "$INSTALL_DIR/" -name $pkg) ]]; then
		output="$INSTALL_DIR/$pkg"
	fi

	echo $output
}

#-----------------------------------------------------------------------------#
function check_file ( )
{
	pkg=$1
	local output=""
	if [[ $(find "$PKG_DIR/" -maxdepth 1 -name $pkg) ]]; then
		output="$PKG_DIR/$pkg"
	fi

	echo $output
}

#-----------------------------------------------------------------------------#
function check_mirror ( )
{
	pkg=$1
	local output=""
	local url="$MIRROR"
	if [[ "$list" == *"lfs-base.list" ]]; then
	       url="$url/lfs-base/$pkg"
        else
		dir=${pkg:0:1}
		url="$url/$dir/$pkg"
	fi

        wget -q --spider $url
	if [[ $? -eq 0 ]]; then
		output=$url
	fi

	echo $output
}



#-----------------------------------------------------------------------------#
function usage ( )
{
	echo "-c | --create"
	echo "-s | --status"
	echo "-d | --download"
	echo "-i | --install"
	echo "-u | --remove-status"
	exit
}

###############################################################################
### MAIN ###

# parse command line
action=$1
list=$2
install_cmd=$3


case $action in
    -c|--create )
        createList
        ;;
    -s|--install-status )
	installStatus
        ;;
    -d|--download )
    	downloadDeps
        ;;
    -i|--install )
    	installDeps
        ;;
    -u|--remove-status )
    	removeStatus
        ;;
    * ) usage ;;
esac

###############################################################################


